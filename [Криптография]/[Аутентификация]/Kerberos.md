# Kerberos

Три стороны - три головы - клиент, сервер и центр распределения ключей (KDC | TGS).

Схема 1 (нерабочая):

Центр хранит ключи каждого своего абонента. В момент, когда клиент хочет связаться с сервером - клиент обращается к KDC и KDC отправляет сгенерированный сессионный ключ каждому участинику сеанса.

Схема 2 (рабочая):

Оба сессионных ключа получает клиент. Сессионный ключ клиента зашифрован постоянным ключем клиента. Сеансовый ключ сервера дополнен информацией о клиенте и и шифруется в "сессионный мандат (session ticket)" серверным постоянным ключем.

Ключ и мандат лежат в безопасной зоне оперативной памяти. Когда клиент связывается с сервером - он отправляет ему мандат и свой аутентификатор, зашифрованный сессионным ключем.

В случае требования аутентификации сервера - сервер извлекает временную метку из аутентификатора клиента, шифрует ее сессионным ключем и отправляет назад.

Сервер не хранит сессионные ключи - они хранятся у клиентов и каждый раз присылаются серверу в мандате.

У мандата есть срок годности, прописанный KDC.

---

#### Kerberos 4

На сцену выходит TGT - ticket granting ticket (мандат твоего мандата) - схема при которой клиент может аутентифицироваться множество раз, применив свои доверенные данные только однажды.

Для этого Kerberos делится на два компонента - AS (Authentication Server) и TGS (ticket granting server). Оба обычно находятся в едином KDC.

Первым делом клиент когда обращается к KDC посылает **AS_REQ** (запрос к серверу аутентификации в виде открытого теста): 

* идентификационные данные клиента, 
* метку времени клиента и 
* идентификатор сервера, предоставляющего мандат (TGS). 

KDC генерирует сеансовый ключ, и отправляет две копии клиенту - одну для клиента, другую для TGS. KDC формирует **AS_REP** зашифрованный долгосрочным ключем клиента - сообщение включает 

* TGT, зашифрованный TGS ключом (TGT содержит: 
  * копию сессионного ключа для TGS, 
  * идентификатор клиента, 
  * время жизни мандата, 
  * метку времени центра распределения ключей (KDC), 
  * IP-адрес клиента) 
* копию сессионного ключа для клиента, 
* время жизни мандата,
* идентификатор TGS

Когда пользователь захочет получить доступ к сервису - он готовит **TGS_REQ**:

* идентификатор сервиса, 
* копию TGT, полученную ранее, 
* аутентификатор (аутентификатор состоит из метки времени, зашифрованной сессионным ключом, полученным от сервера аутентификации, и служит для защиты от повторов)

При получении запроса мандата от клиента KDC формирует новый сессионный ключ для взаимодействия клиент/сервис. Затем отправляет ответное сообщение **TGS_REP**, зашифрованное сессионным ключом, полученным от сервера аутентификации:

* новый сеансовый ключ, 
* мандат сервиса, зашифрованный долговременным ключом сервиса, (содержит:
  * копию нового сессионного ключа, 
  * идентификатор клиента, 
  * время жизни мандата, 
  * локальное время центра распределения ключей, 
  * IP-адрес клиента). 
* идентификатор сервиса,
* время жизни мандата 

#### Kerberos 5

Отличается от предыдущего шифрованием и наличием предварительной аутентификацией перед выдачи TGT.



### Golden Ticket

Golden Ticket - это поддельный TGT 